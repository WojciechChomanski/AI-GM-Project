<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Session Debug Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px 16px; flex: 1 1 420px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 6px 8px; text-align: left; font-size: 14px; }
    h2 { margin: 8px 0 12px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #f8f8f8; cursor: pointer; }
    .muted { color: #666; font-size: 12px; }
    pre { background: #fafafa; border: 1px solid #eee; padding: 8px; border-radius: 8px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Session Debug Panel</h1>

  <div class="card">
    <h2>Actions</h2>
    <div>
      <button id="btnReset">Reset</button>
      <button id="btnInit">Init</button>
      <button id="btnHoldBonus">Resolve Hold (success + bonus)</button>
      <button id="btnDoorBonus">Resolve Door (success + bonus)</button>
      <button id="btnHoldFail">Resolve Hold (failure)</button>
    </div>
    <p class="muted">These call your PowerShell script via the dev server and then reload the state.</p>
  </div>

  <div class="row">
    <div class="card" style="max-width: 600px;">
      <h2>Flags</h2>
      <div id="flags"></div>
    </div>

    <div class="card" style="max-width: 600px;">
      <h2>Vendor Adjustments</h2>
      <div id="vendors"></div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h2>Journal</h2>
      <div id="journal"></div>
    </div>

  <div class="card">
      <h2>History</h2>
      <div id="history"></div>
    </div>
  </div>

  <div class="card">
    <h2>Raw State</h2>
    <pre id="raw">Loading…</pre>
  </div>

  <script>
    async function api(path, opts = {}) {
      const res = await fetch(path, { method: 'GET', ...opts, headers: { 'Content-Type': 'application/json', ...(opts.headers||{}) } });
      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.ok === false) throw new Error(json.error || res.statusText);
      return json;
    }

    async function loadSession() {
      const { state } = await api('/api/session');
      render(state || {});
    }

    function renderFlags(flagsObj) {
      const entries = Object.entries(flagsObj || {});
      if (entries.length === 0) return '<p class="muted">No flags yet</p>';
      const rows = entries.map(([k, v]) => {
        const scope = v?.scope ?? '';
        const value = (typeof v?.value === 'object') ? JSON.stringify(v.value) : String(v?.value);
        const updated = v?.updated_utc ?? '';
        return `<tr><td>${k}</td><td>${value}</td><td>${scope}</td><td>${updated}</td></tr>`;
      }).join('');
      return `<table><thead><tr><th>Flag</th><th>Value</th><th>Scope</th><th>Updated</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderVendors(vendors) {
      const entries = Object.entries(vendors || {});
      if (entries.length === 0) return '<p class="muted">No vendor adjustments</p>';
      return entries.map(([id, v]) => `
        <section>
          <h4>${id}</h4>
          <ul>
            <li>discount_pct: ${v?.discount_pct ?? ''}</li>
            <li>bench_time_credit_min: ${v?.bench_time_credit_min ?? 0}</li>
            <li>expires: ${v?.expires ?? ''}</li>
            <li>notes: ${(v?.notes || []).join(', ')}</li>
            <li>updated: ${v?.updated_utc ?? ''}</li>
          </ul>
        </section>
      `).join('');
    }

    function renderJournal(lines) {
      if (!lines || lines.length === 0) return '<p class="muted">Journal is empty</p>';
      return `<ul>${lines.map(l => `<li>${l}</li>`).join('')}</ul>`;
    }

    function renderHistory(items) {
      if (!items || items.length === 0) return '<p class="muted">No history</p>';
      const rows = items.map(h =>
        `<tr><td>${h.timestamp_utc}</td><td>${h.event_id}</td><td>${h.outcome}</td><td>${(h.bonus||[]).join(', ')}</td></tr>`
      ).join('');
      return `<table><thead><tr><th>Time</th><th>Event</th><th>Outcome</th><th>Bonus</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function render(state) {
      document.querySelector('#flags').innerHTML = renderFlags(state.flags || {});
      document.querySelector('#vendors').innerHTML = renderVendors(state.vendor_adjustments || {});
      document.querySelector('#journal').innerHTML = renderJournal(state.journal || []);
      document.querySelector('#history').innerHTML = renderHistory(state.history || []);
      document.querySelector('#raw').textContent = JSON.stringify(state, null, 2);
    }

    // buttons
    document.querySelector('#btnReset').addEventListener('click', async () => { await api('/api/session/reset', { method: 'POST' }); await loadSession(); });
    document.querySelector('#btnInit').addEventListener('click', async () => { await api('/api/session/init', { method: 'POST' }); await loadSession(); });
    document.querySelector('#btnHoldBonus').addEventListener('click', async () => {
      await api('/api/session/resolve', {
        method: 'POST',
        body: JSON.stringify({ eventId: 'evt_hold_the_cut_v0_6b', outcome: 'success', bonusObjectives: ['OBJ_MIN_INJURY'] })
      }); await loadSession();
    });
    document.querySelector('#btnDoorBonus').addEventListener('click', async () => {
      await api('/api/session/resolve', {
        method: 'POST',
        body: JSON.stringify({ eventId: 'evt_door_to_breach_v0_6b', outcome: 'success', bonusObjectives: ['OBJ_SAFE'] })
      }); await loadSession();
    });
    document.querySelector('#btnHoldFail').addEventListener('click', async () => {
      await api('/api/session/resolve', {
        method: 'POST',
        body: JSON.stringify({ eventId: 'evt_hold_the_cut_v0_6b', outcome: 'failure' })
      }); await loadSession();
    });

    loadSession().catch(err => {
      document.querySelector('#raw').textContent = 'Error: ' + err.message;
    });
  </script>
</body>
</html>
